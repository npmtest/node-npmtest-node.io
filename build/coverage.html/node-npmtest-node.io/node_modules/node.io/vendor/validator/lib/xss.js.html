<!doctype html>
<html lang="en">
<head>
    <title>Code coverage report for node-npmtest-node.io/node_modules/node.io/vendor/validator/lib/xss.js</title>
    <meta charset="utf-8">
    <style>
        body, html {
            margin:0; padding: 0;
        }
        body {
            font-family: Arial, Helvetica;
            font-size: 10pt;
        }
        div.header, div.footer {
            background: #eee;
            padding: 1em;
        }
        div.header {
            height: 160px;
            padding: 0 1em 0 1em;
            z-index: 100;
            position: fixed;
            top: 0;
            border-bottom: 1px solid #666;
            width: 100%;
        }
        div.footer {
            border-top: 1px solid #666;
        }
        div.body {
            margin-top: 170px;
        }
        div.meta {
            font-size: 90%;
            text-align: center;
        }
        h1, h2, h3 {
            font-weight: normal;
        }
        h1 {
            font-size: 12pt;
        }
        h2 {
            font-size: 10pt;
        }
        pre {
            font-family: Menlo, Monaco, Consolas, Courier New, monospace;
            margin: 0;
            padding: 0;
            font-size: 14px;
            tab-size: 2;
        }

        div.path { font-size: 110%; }
        div.path a:link, div.path a:visited { color: #000; }
        table.coverage { border-collapse: collapse; margin:0; padding: 0 }

        table.coverage td {
            margin: 0;
            padding: 0;
            color: #111;
            vertical-align: top;
        }
        table.coverage td.line-count {
            width: 50px;
            text-align: right;
            padding-right: 5px;
        }
        table.coverage td.line-coverage {
            color: #777 !important;
            text-align: right;
            border-left: 1px solid #666;
            border-right: 1px solid #666;
        }

        table.coverage td.text {
        }

        table.coverage td span.cline-any {
            display: inline-block;
            padding: 0 5px;
            width: 40px;
        }
        table.coverage td span.cline-neutral {
            background: #eee;
        }
        table.coverage td span.cline-yes {
            background: #b5d592;
            color: #999;
        }
        table.coverage td span.cline-no {
            background: #fc8c84;
        }

        .cstat-yes { color: #111; }
        .cstat-no { background: #fc8c84; color: #111; }
        .fstat-no { background: #ffc520; color: #111 !important; }
        .cbranch-no { background:  yellow !important; color: #111; }

        .cstat-skip { background: #ddd; color: #111; }
        .fstat-skip { background: #ddd; color: #111 !important; }
        .cbranch-skip { background: #ddd !important; color: #111; }

        .missing-if-branch {
            display: inline-block;
            margin-right: 10px;
            position: relative;
            padding: 0 4px;
            background: black;
            color: yellow;
        }

        .skip-if-branch {
            display: none;
            margin-right: 10px;
            position: relative;
            padding: 0 4px;
            background: #ccc;
            color: white;
        }

        .missing-if-branch .typ, .skip-if-branch .typ {
            color: inherit !important;
        }

        .entity, .metric { font-weight: bold; }
        .metric { display: inline-block; border: 1px solid #333; padding: 0.3em; background: white; }
        .metric small { font-size: 80%; font-weight: normal; color: #666; }

        div.coverage-summary table { border-collapse: collapse; margin: 3em; font-size: 110%; }
        div.coverage-summary td, div.coverage-summary table  th { margin: 0; padding: 0.25em 1em; border-top: 1px solid #666; border-bottom: 1px solid #666; }
        div.coverage-summary th { text-align: left; border: 1px solid #666; background: #eee; font-weight: normal; }
        div.coverage-summary th.file { border-right: none !important; }
        div.coverage-summary th.pic { border-left: none !important; text-align: right; }
        div.coverage-summary th.pct { border-right: none !important; }
        div.coverage-summary th.abs { border-left: none !important; text-align: right; }
        div.coverage-summary td.pct { text-align: right; border-left: 1px solid #666; }
        div.coverage-summary td.abs { text-align: right; font-size: 90%; color: #444; border-right: 1px solid #666; }
        div.coverage-summary td.file { text-align: right; border-left: 1px solid #666; white-space: nowrap;  }
        div.coverage-summary td.pic { min-width: 120px !important;  }
        div.coverage-summary a:link { color: #000; }
        div.coverage-summary a:visited { color: #333; }
        div.coverage-summary tfoot td { border-top: 1px solid #666; }

        div.coverage-summary .yui3-datatable-sort-indicator, div.coverage-summary .dummy-sort-indicator {
            height: 10px;
            width: 7px;
            display: inline-block;
            margin-left: 0.5em;
        }
        div.coverage-summary .yui3-datatable-sort-indicator {
            background: no-repeat scroll 0 0 transparent;
        }
        div.coverage-summary .yui3-datatable-sorted .yui3-datatable-sort-indicator {
            background-position: 0 -20px;
        }
        div.coverage-summary .yui3-datatable-sorted-desc .yui3-datatable-sort-indicator {
            background-position: 0 -10px;
        }

        .high { background: #b5d592 !important; }
        .medium { background: #ffe87c !important; }
        .low { background: #fc8c84 !important; }

        span.cover-fill, span.cover-empty {
            display:inline-block;
            border:1px solid #444;
            background: white;
            height: 12px;
        }
        span.cover-fill {
            background: #ccc;
            border-right: 1px solid #444;
        }
        span.cover-empty {
            background: white;
            border-left: none;
        }
        span.cover-full {
            border-right: none !important;
        }
        pre.prettyprint {
            border: none !important;
            padding: 0 !important;
            margin: 0 !important;
        }
        .com { color: #999 !important; }
        .ignore-none { color: #999; font-weight: normal; }

    </style>
</head>
<body>
<div class="header low">
    <h1 style="font-weight: bold;">
        <a href="https://github.com/npmtest/node-npmtest-node.io">npmtest-node.io (v0.0.1)</a>
    </h1>
    <h1>Code coverage report for <span class="entity">node-npmtest-node.io/node_modules/node.io/vendor/validator/lib/xss.js</span></h1>
    <h2>
        
        Statements: <span class="metric">14.29% <small>(10 / 70)</small></span> &nbsp;&nbsp;&nbsp;&nbsp;
        
        
        Branches: <span class="metric">0% <small>(0 / 18)</small></span> &nbsp;&nbsp;&nbsp;&nbsp;
        
        
        Functions: <span class="metric">0% <small>(0 / 11)</small></span> &nbsp;&nbsp;&nbsp;&nbsp;
        
        
        Lines: <span class="metric">14.29% <small>(10 / 70)</small></span> &nbsp;&nbsp;&nbsp;&nbsp;
        
        Ignored: <span class="metric"><span class="ignore-none">none</span></span> &nbsp;&nbsp;&nbsp;&nbsp;
    </h2>
    <div class="path"><a href="../../../../../../index.html">All files</a> &#187; <a href="index.html">node-npmtest-node.io/node_modules/node.io/vendor/validator/lib/</a> &#187; xss.js</div>
</div>
<div class="body">
<pre><table class="coverage">
<tr><td class="line-count">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205</td><td class="line-coverage"><span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span></td><td class="text"><pre class="prettyprint lang-js">//This module is adapted from the CodeIgniter framework
//The license is available at http://codeigniter.com/
&nbsp;
var html_entity_decode = require('./entities').decode;
&nbsp;
var never_allowed_str = {
    'document.cookie':              '[removed]',
    'document.write':               '[removed]',
    '.parentNode':                  '[removed]',
    '.innerHTML':                   '[removed]',
    'window.location':              '[removed]',
    '-moz-binding':                 '[removed]',
    '&lt;!--':                         '&amp;lt;!--',
    '--&gt;':                          '--&amp;gt;',
    '&lt;![CDATA[':                    '&amp;lt;![CDATA['
};
&nbsp;
var never_allowed_regex = {
    'javascript\\s*:':              '[removed]',
    'expression\\s*(\\(|&amp;\\#40;)':  '[removed]',
    'vbscript\\s*:':                '[removed]',
    'Redirect\\s+302':              '[removed]'
};
&nbsp;
var non_displayables = [
    /%0[0-8bcef]/g,           // url encoded 00-08, 11, 12, 14, 15
    /%1[0-9a-f]/g,            // url encoded 16-31
    /[\x00-\x08]/g,           // 00-08
    /\x0b/g, /\x0c/g,         // 11,12
    /[\x0e-\x1f]/g            // 14-31
];
&nbsp;
var compact_words = [
    'javascript', 'expression', 'vbscript',
    'script', 'applet', 'alert', 'document',
    'write', 'cookie', 'window'
];
&nbsp;
exports.clean = <span class="fstat-no" title="function not covered" >function(str, is_image) {</span>
&nbsp;
    //Recursively clean objects and arrays
<span class="cstat-no" title="statement not covered" >    if (typeof str === 'array' || typeof str === 'object') {</span>
<span class="cstat-no" title="statement not covered" >        for (var i in str) {</span>
<span class="cstat-no" title="statement not covered" >            str[i] = exports.clean(str[i]);</span>
        }
<span class="cstat-no" title="statement not covered" >        return str;</span>
    }
&nbsp;
    //Remove invisible characters
<span class="cstat-no" title="statement not covered" >    str = remove_invisible_characters(str);</span>
&nbsp;
    //Protect query string variables in URLs =&gt; 901119URL5918AMP18930PROTECT8198
<span class="cstat-no" title="statement not covered" >    str = str.replace(/\&amp;([a-z\_0-9]+)\=([a-z\_0-9]+)/i, xss_hash() + '$1=$2');</span>
&nbsp;
    //Validate standard character entities - add a semicolon if missing.  We do this to enable
    //the conversion of entities to ASCII later.
<span class="cstat-no" title="statement not covered" >    str = str.replace(/(&amp;\#?[0-9a-z]{2,})([\x00-\x20])*;?/i, '$1;$2');</span>
&nbsp;
    //Validate UTF16 two byte encoding (x00) - just as above, adds a semicolon if missing.
<span class="cstat-no" title="statement not covered" >    str = str.replace(/(&amp;\#x?)([0-9A-F]+);?/i, '$1;$2');</span>
&nbsp;
    //Un-protect query string variables
<span class="cstat-no" title="statement not covered" >    str = str.replace(xss_hash(), '&amp;');</span>
&nbsp;
    //Decode just in case stuff like this is submitted:
    //&lt;a href="http://%77%77%77%2E%67%6F%6F%67%6C%65%2E%63%6F%6D"&gt;Google&lt;/a&gt;
<span class="cstat-no" title="statement not covered" >    try{  </span>
<span class="cstat-no" title="statement not covered" >      str = decodeURIComponent(str);</span>
    }
    catch(error){
      // str was not actually URI-encoded
    }
&nbsp;
    //Convert character entities to ASCII - this permits our tests below to work reliably.
    //We only convert entities that are within tags since these are the ones that will pose security problems.
<span class="cstat-no" title="statement not covered" >    str = str.replace(/[a-z]+=([\'\"]).*?\\1/gi, <span class="fstat-no" title="function not covered" >function(m, match) {</span></span>
<span class="cstat-no" title="statement not covered" >        return m.replace(match, convert_attribute(match));</span>
    });
&nbsp;
    //Remove invisible characters again
<span class="cstat-no" title="statement not covered" >    str = remove_invisible_characters(str);</span>
&nbsp;
    //Convert tabs to spaces
<span class="cstat-no" title="statement not covered" >    str = str.replace('\t', ' ');</span>
&nbsp;
    //Captured the converted string for later comparison
<span class="cstat-no" title="statement not covered" >    var converted_string = str;</span>
&nbsp;
    //Remove strings that are never allowed
<span class="cstat-no" title="statement not covered" >    for (var i in never_allowed_str) {</span>
<span class="cstat-no" title="statement not covered" >        str = str.replace(i, never_allowed_str[i]);</span>
    }
&nbsp;
    //Remove regex patterns that are never allowed
<span class="cstat-no" title="statement not covered" >    for (var i in never_allowed_regex) {</span>
<span class="cstat-no" title="statement not covered" >        str = str.replace(new RegExp(i, 'i'), never_allowed_regex[i]);</span>
    }
&nbsp;
    //Compact any exploded words like:  j a v a s c r i p t
    // We only want to do this when it is followed by a non-word character
<span class="cstat-no" title="statement not covered" >    for (var i in compact_words) {</span>
<span class="cstat-no" title="statement not covered" >        var spacified = compact_words[i].split('').join('\\s*')+'\\s*';</span>
&nbsp;
<span class="cstat-no" title="statement not covered" >        str = str.replace(new RegExp('('+spacified+')(\\W)', 'ig'), <span class="fstat-no" title="function not covered" >function(m, compat, after) {</span></span>
<span class="cstat-no" title="statement not covered" >            return compat.replace(/\s+/g, '') + after;</span>
        });
    }
&nbsp;
    //Remove disallowed Javascript in links or img tags
<span class="cstat-no" title="statement not covered" >    do {</span>
<span class="cstat-no" title="statement not covered" >        var original = str;</span>
&nbsp;
<span class="cstat-no" title="statement not covered" >        if (str.match(/&lt;a/i)) {</span>
<span class="cstat-no" title="statement not covered" >            str = str.replace(/&lt;a\\s+([^&gt;]*?)(&gt;|$)/gi, <span class="fstat-no" title="function not covered" >function(m, attributes, end_tag) {</span></span>
<span class="cstat-no" title="statement not covered" >                attributes = filter_attributes(attributes.replace('&lt;','').replace('&gt;',''));</span>
<span class="cstat-no" title="statement not covered" >                return m.replace(attributes, attributes.replace(/href=.*?(alert\(|alert&amp;\#40;|javascript\:|charset\=|window\.|document\.|\.cookie|&lt;script|&lt;xss|base64\\s*,)/gi, ''));</span>
            });
        }
&nbsp;
<span class="cstat-no" title="statement not covered" >        if (str.match(/&lt;img/i)) {</span>
<span class="cstat-no" title="statement not covered" >            str = str.replace(/&lt;img\\s+([^&gt;]*?)(\\s?\/?&gt;|$)/gi, <span class="fstat-no" title="function not covered" >function(m, attributes, end_tag) {</span></span>
<span class="cstat-no" title="statement not covered" >                attributes = filter_attributes(attributes.replace('&lt;','').replace('&gt;',''));</span>
<span class="cstat-no" title="statement not covered" >                return m.replace(attributes, attributes.replace(/src=.*?(alert\(|alert&amp;\#40;|javascript\:|charset\=|window\.|document\.|\.cookie|&lt;script|&lt;xss|base64\\s*,)/gi, ''));</span>
            });
        }
&nbsp;
<span class="cstat-no" title="statement not covered" >        if (str.match(/script/i) || str.match(/xss/i)) {</span>
<span class="cstat-no" title="statement not covered" >            str = str.replace(/&lt;(\/*)(script|xss)(.*?)\&gt;/gi, '[removed]');</span>
        }
&nbsp;
    } while(original != str);
&nbsp;
    //Remove JavaScript Event Handlers - Note: This code is a little blunt.  It removes the event
    //handler and anything up to the closing &gt;, but it's unlikely to be a problem.
<span class="cstat-no" title="statement not covered" >    event_handlers = ['[^a-z_\-]on\w*'];</span>
&nbsp;
    //Adobe Photoshop puts XML metadata into JFIF images, including namespacing,
    //so we have to allow this for images
<span class="cstat-no" title="statement not covered" >    if (!is_image) {</span>
<span class="cstat-no" title="statement not covered" >        event_handlers.push('xmlns');</span>
    }
&nbsp;
<span class="cstat-no" title="statement not covered" >    str = str.replace(new RegExp("&lt;([^&gt;&lt;]+?)("+event_handlers.join('|')+")(\\s*=\\s*[^&gt;&lt;]*)([&gt;&lt;]*)", 'i'), '&lt;$1$4');</span>
&nbsp;
    //Sanitize naughty HTML elements
    //If a tag containing any of the words in the list
    //below is found, the tag gets converted to entities.
    //So this: &lt;blink&gt;
    //Becomes: &amp;lt;blink&amp;gt;
<span class="cstat-no" title="statement not covered" >    naughty = 'alert|applet|audio|basefont|base|behavior|bgsound|blink|body|embed|expression|form|frameset|frame|head|html|ilayer|iframe|input|isindex|layer|link|meta|object|plaintext|style|script|textarea|title|video|xml|xss';</span>
<span class="cstat-no" title="statement not covered" >    str = str.replace(new RegExp('&lt;(/*\\s*)('+naughty+')([^&gt;&lt;]*)([&gt;&lt;]*)', 'gi'), <span class="fstat-no" title="function not covered" >function(m, a, b, c, d) {</span></span>
<span class="cstat-no" title="statement not covered" >        return '&amp;lt;' + a + b + c + d.replace('&gt;','&amp;gt;').replace('&lt;','&amp;lt;');</span>
    });
&nbsp;
    //Sanitize naughty scripting elements Similar to above, only instead of looking for
    //tags it looks for PHP and JavaScript commands that are disallowed.  Rather than removing the
    //code, it simply converts the parenthesis to entities rendering the code un-executable.
    //For example:    eval('some code')
    //Becomes:        eval&amp;#40;'some code'&amp;#41;
<span class="cstat-no" title="statement not covered" >    str = str.replace(/(alert|cmd|passthru|eval|exec|expression|system|fopen|fsockopen|file|file_get_contents|readfile|unlink)(\\s*)\((.*?)\)/gi, '$1$2&amp;#40;$3&amp;#41;');</span>
&nbsp;
    //This adds a bit of extra precaution in case something got through the above filters
<span class="cstat-no" title="statement not covered" >    for (var i in never_allowed_str) {</span>
<span class="cstat-no" title="statement not covered" >        str = str.replace(i, never_allowed_str[i]);</span>
    }
<span class="cstat-no" title="statement not covered" >    for (var i in never_allowed_regex) {</span>
<span class="cstat-no" title="statement not covered" >        str = str.replace(new RegExp(i, 'i'), never_allowed_regex[i]);</span>
    }
&nbsp;
    //Images are handled in a special way
<span class="cstat-no" title="statement not covered" >    if (is_image &amp;&amp; str !== converted_string) {</span>
<span class="cstat-no" title="statement not covered" >        throw new Error('Image may contain XSS');</span>
    }
&nbsp;
<span class="cstat-no" title="statement not covered" >    return str;</span>
}
&nbsp;
<span class="fstat-no" title="function not covered" >function remove_invisible_characters(str) {</span>
<span class="cstat-no" title="statement not covered" >    for (var i in non_displayables) {</span>
<span class="cstat-no" title="statement not covered" >        str = str.replace(non_displayables[i], '');</span>
    }
<span class="cstat-no" title="statement not covered" >    return str;</span>
}
&nbsp;
<span class="fstat-no" title="function not covered" >function xss_hash() {</span>
    //TODO: Create a random hash
<span class="cstat-no" title="statement not covered" >    return '!*$^#(@*#&amp;';</span>
}
&nbsp;
<span class="fstat-no" title="function not covered" >function convert_attribute(str) {</span>
<span class="cstat-no" title="statement not covered" >    return str.replace('&gt;','&amp;gt;').replace('&lt;','&amp;lt;').replace('\\','\\\\');</span>
}
&nbsp;
//Filter Attributes - filters tag attributes for consistency and safety
<span class="fstat-no" title="function not covered" >function filter_attributes(str) {</span>
<span class="cstat-no" title="statement not covered" >    out = '';</span>
&nbsp;
<span class="cstat-no" title="statement not covered" >    str.replace(/\\s*[a-z\-]+\\s*=\\s*(?:\042|\047)(?:[^\\1]*?)\\1/gi, <span class="fstat-no" title="function not covered" >function(m) {</span></span>
<span class="cstat-no" title="statement not covered" >        $out += m.replace(/\/\*.*?\*\//g, '');</span>
    });
&nbsp;
<span class="cstat-no" title="statement not covered" >    return out;</span>
}
&nbsp;
&nbsp;</pre></td></tr>
</table></pre>
</div>
<div class="footer">
    <div class="meta">Generated by <a href="https://github.com/kaizhu256/node-utility2" target="_blank">utility2</a> at Fri Apr 21 2017 18:14:56 GMT+0000 (UTC)</div>
</div>
</body>
</html>
